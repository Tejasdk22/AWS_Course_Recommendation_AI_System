# üöÄ Deploy Bedrock-Powered Streamlit App to EC2

## üìã Manual Deployment Steps

Since SSH is not working, here are the manual steps to deploy the Bedrock-powered system:

### 1. **SSH into your EC2 instance:**
```bash
ssh -i your-key.pem ec2-user@107.21.159.25
```

### 2. **Create the new Bedrock-powered Streamlit app:**
```bash
cd /opt/career-guidance
sudo nano streamlit_app_bedrock.py
```

### 3. **Copy and paste this content into the file:**
```python
import streamlit as st
import requests
import json
import time
import re
from datetime import datetime
import boto3
from botocore.exceptions import ClientError
import os
from dotenv import load_dotenv
import asyncio
import sys

# Add the current directory to Python path to import our modules
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

# Load environment variables
load_dotenv()

# Import the working multi-agent system
from career_guidance_system import CareerGuidanceSystem

# Page configuration
st.set_page_config(
    page_title="UTD Course Recommendation AI - Bedrock Powered",
    page_icon="üéì",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Custom CSS
st.markdown("""
<style>
    .main-header {
        background: linear-gradient(90deg, #1f2937 0%, #374151 100%);
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
    }
    .main-header h1 {
        color: white;
        margin: 0;
        font-size: 2.5rem;
    }
    .main-header p {
        color: #d1d5db;
        margin: 0.5rem 0 0 0;
        font-size: 1.2rem;
    }
    .bedrock-badge {
        background: linear-gradient(90deg, #ff6b35 0%, #f7931e 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: bold;
        display: inline-block;
        margin-top: 0.5rem;
    }
    .bedrock-status {
        background: #10b981;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
    }
</style>
""", unsafe_allow_html=True)

# Initialize the multi-agent system
@st.cache_resource
def get_career_system():
    """Initialize the career guidance system with caching"""
    try:
        system = CareerGuidanceSystem()
        return system
    except Exception as e:
        st.error(f"Failed to initialize career guidance system: {e}")
        return None

async def call_bedrock_api(major, student_type, career_goal):
    """Call the real Bedrock-powered multi-agent system"""
    try:
        system = get_career_system()
        if not system:
            return None
        
        # Create query
        query = f"I want to become a {career_goal}"
        session_id = f"streamlit_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        
        # Process with multi-agent system
        response = await system.process_query(
            user_query=query,
            major=major,
            student_type=student_type,
            session_id=session_id
        )
        
        # Convert to dict format for Streamlit
        return {
            'unified_response': response.unified_response,
            'job_market_insights': response.job_market_insights,
            'course_recommendations': response.course_recommendations,
            'career_matching_analysis': response.career_matching_analysis,
            'project_suggestions': response.project_suggestions,
            'session_id': response.session_id,
            'timestamp': response.timestamp,
            'used_bedrock': True,
            'agents_used': ['JobMarketAgent', 'CourseCatalogAgent', 'CareerMatchingAgent', 'ProjectAdvisorAgent']
        }
        
    except Exception as e:
        st.error(f"Bedrock API Error: {e}")
        return None

def display_recommendations(data):
    """Display recommendations in a nice format"""
    if not data:
        st.error("No data received from Bedrock system")
        return
    
    # Show Bedrock status
    if data.get('used_bedrock'):
        st.markdown('<div class="bedrock-status">ü§ñ Powered by Amazon Bedrock</div>', unsafe_allow_html=True)
    
    # Display the unified response (generated by Bedrock)
    st.markdown("### üéØ AI-Powered Career Guidance")
    st.markdown(data['unified_response'])
    
    # Additional insights in expandable sections
    with st.expander("üìä Detailed Job Market Analysis"):
        st.markdown(data['job_market_insights'])
    
    with st.expander("üìö Detailed Course Recommendations"):
        st.markdown(data['course_recommendations'])
    
    with st.expander("üéØ Detailed Career Matching Analysis"):
        st.markdown(data['career_matching_analysis'])
    
    with st.expander("üöÄ Detailed Project Suggestions"):
        st.markdown(data['project_suggestions'])

def generate_chatbot_response(question, data, query_info):
    """Generate a response for the chatbot using Bedrock"""
    try:
        # Use Bedrock for chatbot responses
        bedrock_client = boto3.client('bedrock-runtime', region_name='us-east-1')
        
        context = f"""
        You are a helpful UTD course advisor chatbot. 
        A {query_info['student_type']} student in {query_info['major']} 
        wants to become a {query_info['career_goal']}. 

        Their course recommendations:
        {data['unified_response'][:2000]}

        Answer their question: {question}

        Be concise, helpful, and specific to UTD courses.
        """
        
        response = bedrock_client.invoke_model(
            modelId="amazon.titan-text-express-v1",
            body=json.dumps({
                "inputText": context,
                "textGenerationConfig": {
                    "maxTokenCount": 500,
                    "temperature": 0.7
                }
            })
        )
        
        response_body = json.loads(response['body'].read())
        ai_response = response_body['results'][0]['outputText']
        
        return ai_response
        
    except Exception as e:
        # Fallback to simple responses
        question_lower = question.lower()
        
        if any(word in question_lower for word in ['course', 'classes', 'curriculum']):
            return f"Based on your {query_info['major']} major and {query_info['career_goal']} career goal, I recommend focusing on the core courses listed above. These will give you the foundational knowledge needed for your career path."
        
        elif any(word in question_lower for word in ['job', 'career', 'salary', 'market']):
            return f"The job market for {query_info['career_goal']} positions shows strong growth potential. Focus on developing the technical skills mentioned in the job market analysis above."
        
        elif any(word in question_lower for word in ['project', 'portfolio', 'experience']):
            return f"To build your portfolio as a {query_info['career_goal']}, start with the beginner projects mentioned above and gradually work your way up to more complex projects."
        
        else:
            return f"I'd be happy to help you with questions about courses, career paths, or projects related to becoming a {query_info['career_goal']}. What specific aspect would you like to know more about?"

def main():
    # Header
    st.markdown("""
    <div class="main-header">
        <h1>üéì UTD Course Recommendation AI</h1>
        <p>Get personalized course recommendations powered by Amazon Bedrock</p>
        <div class="bedrock-badge">ü§ñ Powered by Amazon Bedrock Multi-Agent System</div>
    </div>
    """, unsafe_allow_html=True)
    
    # Sidebar for input
    with st.sidebar:
        st.markdown("### üìù Your Information")
        
        major = st.selectbox(
            "Select your major:",
            [
                "Computer Science", "Business Analytics", "Information Technology and Management",
                "Finance", "Marketing", "Accounting", "Supply Chain Management", 
                "Mathematics", "Statistics"
            ],
            index=0
        )
        
        student_type = st.selectbox(
            "Select your student type:",
            ["Graduate", "Undergraduate"],
            index=0
        )
        
        career_goal = st.selectbox(
            "Select your career goal:",
            [
                # Data & Analytics Roles
                "Data Scientist", "Data Analyst", "Business Analyst", "Data Engineer", "Machine Learning Engineer",
                "Research Scientist", "Quantitative Analyst", "Business Intelligence Analyst",
                
                # Software & Technology Roles
                "Software Engineer", "Full Stack Developer", "Backend Developer", "Frontend Developer",
                "DevOps Engineer", "Cloud Engineer", "Cybersecurity Analyst", "IT Consultant",
                
                # Business & Management Roles
                "Product Manager", "Project Manager", "Business Consultant", "Operations Manager",
                "Supply Chain Manager", "Procurement Manager",
                
                # Finance & Accounting Roles
                "Financial Analyst", "Investment Analyst", "Corporate Accountant", "Auditor",
                
                # Marketing Roles
                "Marketing Manager", "Digital Marketing Specialist", "Brand Manager", "Marketing Analyst"
            ],
            index=0
        )
        
        # Ready section
        st.markdown("---")
        st.markdown("### üöÄ Ready to Get AI Recommendations?")
        
        if st.button("Get AI-Powered Recommendations", type="primary", use_container_width=True):
            # Get AI-powered course recommendations using Bedrock
            with st.spinner("ü§ñ AI agents are analyzing your academic path and generating personalized recommendations..."):
                # Run the async function
                result = asyncio.run(call_bedrock_api(major, student_type, career_goal))
                
                if result is None:
                    st.error("AI recommendations temporarily unavailable. Please try again.")
                    return

            st.success("‚úÖ AI-powered recommendations generated successfully!")
            st.session_state['recommendations'] = result
            st.session_state['query_info'] = {
                'major': major,
                'student_type': student_type,
                'career_goal': career_goal
            }
        
    # Main content area
    if 'recommendations' in st.session_state:
        data = st.session_state['recommendations']
        query_info = st.session_state['query_info']
        
        # Display profile
        st.markdown("### üìã Your Profile")
        col1, col2, col3 = st.columns(3)
        with col1:
            st.metric("Major", query_info['major'])
        with col2:
            st.metric("Student Type", query_info['student_type'])
        with col3:
            st.metric("Career Goal", query_info['career_goal'])
        
        st.markdown("---")
        
        # Create two-column layout: recommendations on left, chatbot on right
        main_col, chat_col = st.columns([2, 1])
        
        with main_col:
            # Display recommendations
            display_recommendations(data)
        
        with chat_col:
            # Chatbot on the right
            st.markdown("### üí¨ AI Course Advisor")
            st.markdown("Ask me about courses! (Powered by Bedrock)")
            
            # Initialize chat history
            if 'chat_history' not in st.session_state:
                st.session_state.chat_history = []
            
            # Display chat history in a scrollable container
            if st.session_state.chat_history:
                chat_height = "400px"
                chat_html = "<div style='border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; height: " + chat_height + "; overflow-y: auto; background-color: #f9f9f9;'>"
                for message in st.session_state.chat_history:
                    if message["role"] == "user":
                        chat_html += f"<div style='text-align: right; margin-bottom: 10px;'><div style='background-color: #0084ff; color: white; padding: 8px 12px; border-radius: 12px; display: inline-block; max-width: 85%; font-size: 0.85rem;'>{message['content']}</div></div>"
                    else:
                        chat_html += f"<div style='text-align: left; margin-bottom: 10px;'><div style='background-color: #e4e6eb; color: black; padding: 8px 12px; border-radius: 12px; display: inline-block; max-width: 85%; font-size: 0.85rem;'>{message['content']}</div></div>"
                chat_html += "</div>"
                st.markdown(chat_html, unsafe_allow_html=True)
            else:
                st.info("üëã Start by asking a question!")
            
            # Text input for new questions
            user_question = st.text_input("Ask a question...", key="chat_input")
            
            ask_button = st.button("Ask", type="primary", use_container_width=True)
            
            if st.button("Clear Chat", use_container_width=True):
                st.session_state.chat_history = []
                st.experimental_rerun()
            
            # Handle question submission
            if ask_button and user_question:
                # Add user message to chat history
                st.session_state.chat_history.append({"role": "user", "content": user_question})
                
                # Generate AI response using Bedrock
                with st.spinner("ü§ñ AI is thinking..."):
                    ai_response = generate_chatbot_response(user_question, data, query_info)
                    st.session_state.chat_history.append({"role": "assistant", "content": ai_response})
                
                st.experimental_rerun()
    
    else:
        # Welcome message
        st.markdown("""
        ### üéØ Welcome to UTD Course Recommendation AI!
        
        This system uses **Amazon Bedrock** with a **multi-agent architecture** to provide personalized career guidance:
        
        #### ü§ñ **AI Agents Working for You:**
        - **JobMarketAgent**: Analyzes current job market trends and requirements
        - **CourseCatalogAgent**: Scrapes and analyzes UTD course catalog
        - **CareerMatchingAgent**: Matches your skills with career requirements
        - **ProjectAdvisorAgent**: Suggests hands-on projects for skill development
        
        #### üöÄ **How It Works:**
        1. **Select your information** in the sidebar
        2. **Click "Get AI-Powered Recommendations"**
        3. **Wait ~40-45 seconds** for AI analysis
        4. **Get personalized recommendations** powered by Bedrock
        
        #### ‚ú® **Features:**
        - Real-time job market analysis
        - Personalized course recommendations
        - Career matching analysis
        - Project suggestions
        - AI-powered chatbot for questions
        
        **Ready to get started?** Use the sidebar to select your information and get your personalized recommendations!
        """)

if __name__ == "__main__":
    main()
```

### 4. **Save the file (Ctrl+X, then Y, then Enter)**

### 5. **Update the systemd service:**
```bash
sudo nano /etc/systemd/system/career-streamlit.service
```

### 6. **Replace the content with:**
```ini
[Unit]
Description=UTD Career Guidance Streamlit App (Bedrock Powered)
After=network.target

[Service]
Type=simple
User=ec2-user
WorkingDirectory=/opt/career-guidance
Environment=PATH=/opt/career-guidance/bedrock_env/bin
ExecStart=/opt/career-guidance/bedrock_env/bin/streamlit run streamlit_app_bedrock.py --server.port=8501 --server.address=0.0.0.0
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

### 7. **Save and restart the service:**
```bash
sudo systemctl daemon-reload
sudo systemctl restart career-streamlit
```

### 8. **Check the status:**
```bash
sudo systemctl status career-streamlit
```

## üéâ **Result:**

After deployment, your Streamlit app will be:

- ‚úÖ **Powered by Amazon Bedrock**
- ‚úÖ **Multi-Agent System** (4 AI agents working together)
- ‚úÖ **Real AI responses** (not hardcoded)
- ‚úÖ **AI-powered chatbot**
- ‚úÖ **Personalized recommendations**

## üåê **Access:**

Visit: `http://107.21.159.25:8501`

## ‚è±Ô∏è **Expected Processing Time:**

~40-45 seconds per query (due to web scraping and AI processing)

## üîß **Troubleshooting:**

If the app doesn't start:
```bash
# Check logs
sudo journalctl -u career-streamlit -f

# Restart service
sudo systemctl restart career-streamlit

# Check if port is open
sudo netstat -tlnp | grep 8501
```

